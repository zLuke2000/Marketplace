config:
    target: 'http://31.156.147.189:5000'
    http:
        timeout: 120
    phases:
        - duration: 20
          arrivalRate: 20
          name: 'Load Test Buy'
    payload:
        - path: 'users.csv'
          fields:
              - 'user'
        - path: 'products.csv'
          fields:
              - 'cid'
              - 'owner'
              - 'price'
              - 'name'
    processor: './processor.cjs'
    plugins:
        expect: {}
scenarios:
    - name: 'test-buy-product'
      flow:
          - log: '[0x{{user}}] request to buy {{ cid }}'
          - post:
                url: '/process-product'
                json:
                    user: '0x{{ user }}'
                    owner: '0x{{ owner }}'
                    cid: '{{ cid }}'
                    price: '{{ price }}'
                capture:
                    - json: '$.requestId'
                      as: 'id'
                afterResponse: printStatus
                expect:
                    - statusCode: 201
          - think: 5
          - post:
                beforeRequest: purchaseProduct
                url: '/buy-product'
                json:
                    requestId: '{{ id }}'
                    user: '0x{{ user }}'
                    cid: '{{ cid }}'
                    owner: '0x{{ owner }}'
                    price: '{{ price }}'
                ifTrue: 'status'
                expect:
                    - statusCode: 201
          - log: '[0x{{ user }}] purchased product {{ cid }}'
